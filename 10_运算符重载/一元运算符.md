# 一元运算符重载

一元运算符是只作用于单个操作数的运算符。Rust 提供 `Neg` 和 `Not` 两个 trait 来重载 `-` 和 `!`。

## 核心概念

| 运算符 | Trait | 方法 | 典型用途 |
| --- | --- | --- | --- |
| `-x` | `std::ops::Neg` | `neg(self)` | 数值取反 |
| `!x` | `std::ops::Not` | `not(self)` | 逻辑非 / 按位非 |

两个 trait 的签名几乎相同：

```rust
pub trait Neg {
    type Output;
    fn neg(self) -> Self::Output;
}

pub trait Not {
    type Output;
    fn not(self) -> Self::Output;
}
```

## Neg：负号运算符

### 基本实现

```rust
use std::ops::Neg;

#[derive(Debug, PartialEq)]
struct Complex {
    re: i32,
    im: i32,
}

impl Neg for Complex {
    type Output = Complex;

    fn neg(self) -> Complex {
        Complex {
            re: -self.re,
            im: -self.im,
        }
    }
}

fn main() {
    let c = Complex { re: 1, im: -2 };
    let neg_c = -c; // 调用 c.neg()
    assert_eq!(neg_c, Complex { re: -1, im: 2 });
    // println!("{:?}", c); // 错误！c 已被移动
}
```

### 为引用实现（保留原值）

```rust
impl Neg for &Complex {
    type Output = Complex;

    fn neg(self) -> Complex {
        Complex {
            re: -self.re,
            im: -self.im,
        }
    }
}

// 用法
let c = Complex { re: 1, im: -2 };
let neg_c = -&c; // c 仍可用
```

## Not：非运算符

### 状态切换示例

```rust
use std::ops::Not;

#[derive(Debug, PartialEq, Clone, Copy)]
enum Switch {
    On,
    Off,
}

impl Not for Switch {
    type Output = Switch;

    fn not(self) -> Switch {
        match self {
            Switch::On => Switch::Off,
            Switch::Off => Switch::On,
        }
    }
}

fn main() {
    let state = Switch::On;
    assert_eq!(!state, Switch::Off);
    assert_eq!(!!state, Switch::On); // 双重取反
}
```

## 注意事项

### 所有权问题

一元运算符方法接收 `self`，会消耗所有权：

```rust
let c = Complex { re: 1, im: 2 };
let neg = -c;
// println!("{:?}", c); // 错误！c 已移动
```

**解决方案**：

| 方案 | 适用场景 |
| --- | --- |
| 为 `&T` 实现 trait | 需要保留原值，使用 `-&x` |
| 让类型实现 `Copy` | 小型、栈上的值类型 |

### Output 类型灵活性

`Output` 可以是任意类型，不必与 `Self` 相同：

```rust
impl Neg for &Complex {
    type Output = Complex; // 引用返回值类型
    // ...
}
```

## 总结

- `Neg` 重载 `-`，`Not` 重载 `!`
- 方法消耗 `self`，注意所有权转移
- 为引用实现 trait 可避免移动原值
