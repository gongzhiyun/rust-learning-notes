# 实用工具特型

标准库提供的一组常用 trait，用于类型转换、克隆、默认值等通用操作，让自定义类型融入 Rust 生态。

## 特型分类

| 类别 | 特型 | 用途 |
| --- | --- | --- |
| 类型转换 | `From`/`Into`、`TryFrom`/`TryInto`、`AsRef`/`AsMut` | 值或引用的类型转换 |
| 借用与所有权 | `Borrow`/`BorrowMut`、`ToOwned`、`Cow` | 借用抽象与写时克隆 |
| 克隆与复制 | `Clone`、`Copy` | 值的复制 |
| 默认值 | `Default` | 提供类型的默认实例 |
| 格式化输出 | `Debug`、`Display` | 文本格式化 |
| 智能指针 | `Deref`/`DerefMut`、`Drop` | 解引用与资源清理 |
| 闭包 | `Fn`、`FnMut`、`FnOnce` | 可调用对象 |
| 大小约束 | `Sized` | 编译期已知大小的类型 |

## 特型速查

| 特型 | 方法 | 说明 |
| --- | --- | --- |
| `From<T>` | `from(T) -> Self` | 从 T 转换，不会失败 |
| `Into<T>` | `into(self) -> T` | 转换为 T，由 From 自动派生 |
| `TryFrom<T>` | `try_from(T) -> Result` | 可能失败的转换 |
| `TryInto<T>` | `try_into(self) -> Result` | 可能失败的转换 |
| `AsRef<T>` | `as_ref(&self) -> &T` | 廉价引用转换 |
| `AsMut<T>` | `as_mut(&mut self) -> &mut T` | 廉价可变引用转换 |
| `Borrow<T>` | `borrow(&self) -> &T` | 借用，要求哈希/比较一致 |
| `BorrowMut<T>` | `borrow_mut(&mut self) -> &mut T` | 可变借用 |
| `ToOwned` | `to_owned(&self) -> Owned` | 从借用创建所有权值 |
| `Cow<T>` | （智能指针类型） | 写时克隆，延迟分配 |
| `Clone` | `clone(&self) -> Self` | 显式深拷贝 |
| `Copy` | （标记特型） | 隐式按位复制 |
| `Default` | `default() -> Self` | 提供默认值 |
| `Debug` | `fmt(&self, f) -> Result` | 调试输出 `{:?}` |
| `Display` | `fmt(&self, f) -> Result` | 用户输出 `{}` |
| `Deref` | `deref(&self) -> &Target` | 不可变解引用 |
| `DerefMut` | `deref_mut(&mut self) -> &mut Target` | 可变解引用 |
| `Drop` | `drop(&mut self)` | 析构函数 |
| `Fn` | `call(&self, args)` | 闭包，不修改环境 |
| `FnMut` | `call_mut(&mut self, args)` | 闭包，可修改环境 |
| `FnOnce` | `call_once(self, args)` | 闭包，消耗环境 |
| `Sized` | （标记特型） | 编译期已知大小 |

## derive 支持

| 可派生特型 | 要求 |
| --- | --- |
| `Debug` | 所有字段实现 Debug |
| `Clone` | 所有字段实现 Clone |
| `Copy` | 所有字段实现 Copy，且需 Clone |
| `Default` | 所有字段实现 Default |
| `PartialEq` / `Eq` | 所有字段实现对应特型 |
| `PartialOrd` / `Ord` | 所有字段实现对应特型 |
| `Hash` | 所有字段实现 Hash |

## 使用场景

| 场景 | 推荐特型 | 说明 |
| --- | --- | --- |
| 接受多种字符串类型 | `AsRef<str>` | 函数参数同时接受 `&str`、`String` |
| 接受多种路径类型 | `AsRef<Path>` | 函数参数同时接受 `&str`、`PathBuf` |
| HashMap 用 String 做键，&str 查找 | `Borrow<str>` | 避免查找时创建临时 String |
| 从 &str 创建 String | `ToOwned` | `"hello".to_owned()` |
| 可能修改也可能不修改的字符串 | `Cow<str>` | 避免不必要的克隆 |
| 类型之间无损转换 | `From`/`Into` | 如 `String::from("hello")` |
| 类型之间可能失败的转换 | `TryFrom`/`TryInto` | 如 `i32::try_from(big_number)` |
| 提供类型默认值 | `Default` | 配合结构体更新语法 `..Default::default()` |
| 自定义智能指针 | `Deref`/`DerefMut` | 实现自动解引用强制转换 |
| 资源清理 | `Drop` | 文件句柄、网络连接等 |
| 小型栈数据按值传递 | `Copy` | 如坐标点、颜色值 |
| 需要显式复制的类型 | `Clone` | 如包含堆数据的结构体 |
| 接受动态大小类型 | `?Sized` | 如 `&str`、`&[T]`、`&dyn Trait` |

## 总结

1. 实用工具特型分为八大类：类型转换、借用与所有权、克隆与复制、默认值、格式化输出、智能指针、闭包、大小约束
2. 大部分常用特型支持 `#[derive(...)]` 自动派生
3. 各特型的详细用法见对应的专题笔记
